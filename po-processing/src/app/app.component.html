<router-outlet></router-outlet>

<div class="container">
  <h1>PO Processing</h1>
  <!-- Warehouse Inventory Input -->
  <div class="form-group row">
    <div class="col-4 border-right">
      <b>Upload Warehouse Excel</b>
      <div class="input-group">
        <div class="custom-file">
          <input
            class="custom-file-input"
            type="file"
            id="file"
            accept=".xls,.xlsx,application/vnd.ms-excel"
            #warehouseUpload
          />
          <label class="custom-file-label" for="file">
            {{ warehouseUpload.files[0] }}
            {{ (warehouseUpload?.files)[0]?.name || 'Choose file...' }}</label
          >
        </div>
      </div>
      <button
        *ngIf="warehouseUpload.files.length > 0"
        class="btn btn-primary mt-2"
        (click)="uploadWarehouseExcelFile(warehouseUpload)"
      >
        Use This File
      </button>
    </div>

    <div class="col-8">
      <app-warehouse-form
        [editing]="warehouseInputBusy"
        (submitEvent)="
          warehouseLotsBySku$.next($event); warehouseInputBusy = false
        "
        [class.d-none]="!warehouseInputBusy"
      ></app-warehouse-form>
      <div
        [class.clickable]="!warehouseInputBusy && !uploadingWarehouseFile"
        [class.d-none]="warehouseInputBusy || uploadingWarehouseFile"
        (click)="warehouseInputBusy = true"
      >
        <b>{{
          warehouseInputBusy
            ? 'Preview'
            : 'Warehouse Data (click to edit directly)'
        }}</b
        ><br />
        <ul class="view gray-bg">
          <li *ngFor="let item of warehouseLotsBySku$ | async | keyvalue">
            <b>{{ item.key }}:</b>
            <ul>
              <li *ngFor="let lot of item.value">
                Lot {{ lot.lotId }}: {{ lot.availableQty }}
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <hr />

  <!-- Purchase Order Set Input -->
  <div class="row">
    <app-po-form
      *ngIf="poInputBusy; else inputNotBusy"
      (submitEvent)="addOrderToSet($event); poInputBusy = false"
      class="col-6"
    ></app-po-form>
    <ng-template #inputNotBusy>
      <div class="col-6">
        <b>Click to add PO</b><br />
        <div class="gray-bg view clickable" (click)="poInputBusy = true"></div>
      </div>
    </ng-template>
    <div class="col-6" [class.view]="poSet.orders.length > 0">
      <b>Current POs</b>
      <table
        *ngFor="let po of poSet.orders"
        class="table table-bordered table-striped"
      >
        <thead class="thead-dark">
          <tr>
            <th>
              Ship to:<br />
              {{ po.shipTo }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let line of po.lines | keyvalue: lineNumberOrder">
            <td>
              <b>Line:&nbsp;</b>{{ line.value.line || 'N/A' }}<br />
              <b>Our SKU:&nbsp;</b>{{ line.value.itemSku || 'N/A' }}<br />
              {{ line.value.description }}<br />
              <b>Unit Price:&nbsp;</b
              >{{ (line.value.unitPrice | currency) || 'N/A' }}<br />
              <b>Quantity:&nbsp;</b>{{ line.value.quantity || 'N/A' }}<br />
              <b>Unit:&nbsp;</b>{{ line.value.unit || 'N/A' }}<br />
              <b>Total:&nbsp;</b
              >{{ (line.value.itemTotal | currency) || 'N/A' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <hr />

  <!-- TODO: Should navigate to another view to avoid confusion -->
  <button
    type="button"
    class="btn btn-lg btn-success mx-auto my-5 d-block"
    (click)="handleClick()"
  >
    Auto select lot
  </button>
  <div class="row" *ngIf="outboundResult && outboundResult.size > 0">
    <div class="col-6">
      <h4>Result</h4>
      <div *ngFor="let sku of outboundResult | keyvalue">
        <b>Item {{ sku.key }}:</b>
        <ul>
          <li *ngFor="let lot of sku.value.qtyPerLot | keyvalue">
            Taken from Lot {{ lot.key }}: {{ lot.value }}
          </li>
          <li *ngIf="sku.value.remaining > 0" class="text-danger">
            <strong
              >This SKU still needs {{ sku.value.remaining }} more
              {{ sku.value.remaining === 1 ? 'item' : 'items' }}</strong
            >
          </li>
        </ul>
      </div>
    </div>
    <div class="col-6">
      <h4>Excel-friendly View</h4>
      <code class="view gray-bg">
        <div *ngFor="let sku of outboundResult | keyvalue">
          <div
            *ngFor="let lot of sku.value.qtyPerLot | keyvalue"
            [class.text-success]="sku.value.remaining === 0"
          >
            {{ sku.key }},{{ lot.key }},{{ lot.value }}
          </div>
        </div>
      </code>
    </div>
  </div>
</div>
